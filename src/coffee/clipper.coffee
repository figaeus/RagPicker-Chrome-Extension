DEFAULT_STYLES = {"background-attachment":"scroll","background-clip":"border-box","background-color":"rgba(0, 0, 0, 0)","background-image":"none","background-origin":"padding-box","background-position":"0% 0%","background-repeat":"repeat","background-size":"auto","border-bottom-color":"rgb(0, 0, 0)","border-bottom-left-radius":"0px","border-bottom-right-radius":"0px","border-bottom-style":"none","border-bottom-width":"0px","border-collapse":"separate","border-image-outset":"0px","border-image-repeat":"stretch","border-image-slice":"100%","border-image-source":"none","border-image-width":"1","border-left-color":"rgb(0, 0, 0)","border-left-style":"none","border-left-width":"0px","border-right-color":"rgb(0, 0, 0)","border-right-style":"none","border-right-width":"0px","border-top-color":"rgb(0, 0, 0)","border-top-left-radius":"0px","border-top-right-radius":"0px","border-top-style":"none","border-top-width":"0px","bottom":"auto","box-shadow":"none","box-sizing":"content-box","caption-side":"top","clear":"none","clip":"auto","color":"rgb(0, 0, 0)","cursor":"auto","direction":"ltr","display":"block","empty-cells":"show","float":"none","font-family":"\"Times New Roman'","font-size":"16px","font-style":"normal","font-variant":"normal","font-weight":"normal","height":"0px","image-rendering":"auto","left":"auto","letter-spacing":"normal","line-height":"16px","list-style-image":"none","list-style-position":"outside","list-style-type":"disc","margin-bottom":"0px","margin-left":"0px","margin-right":"0px","margin-top":"0px","max-height":"none","max-width":"none","min-height":"0px","min-width":"0px","opacity":"1","orphans":"auto","outline-color":"rgb(0, 0, 0)","outline-offset":"0px","outline-style":"none","outline-width":"0px","overflow-wrap":"normal","overflow-x":"visible","overflow-y":"visible","padding-bottom":"0px","padding-left":"0px","padding-right":"0px","padding-top":"0px","page-break-after":"auto","page-break-before":"auto","page-break-inside":"auto","pointer-events":"auto","position":"static","resize":"none","right":"auto","speak":"normal","table-layout":"auto","tab-size":"8","text-align":"start","text-decoration":"none","text-indent":"0px","text-rendering":"auto","text-shadow":"none","text-overflow":"clip","text-transform":"none","top":"auto","transition-delay":"0s","transition-duration":"0s","transition-property":"all","transition-timing-function":"ease","unicode-bidi":"normal","vertical-align":"baseline","visibility":"visible","white-space":"normal","widows":"auto","width":"456px","word-break":"normal","word-spacing":"0px","word-wrap":"normal","z-index":"auto","zoom":"1","-webkit-animation-delay":"0s","-webkit-animation-direction":"normal","-webkit-animation-duration":"0s","-webkit-animation-fill-mode":"none","-webkit-animation-iteration-count":"1","-webkit-animation-name":"none","-webkit-animation-play-state":"running","-webkit-animation-timing-function":"ease","-webkit-appearance":"none","-webkit-backface-visibility":"visible","-webkit-background-clip":"border-box","-webkit-background-composite":"source-over","-webkit-background-origin":"padding-box","-webkit-background-size":"auto","-webkit-border-fit":"border","-webkit-border-horizontal-spacing":"0px","-webkit-border-image":"none","-webkit-border-vertical-spacing":"0px","-webkit-box-align":"stretch","-webkit-box-decoration-break":"slice","-webkit-box-direction":"normal","-webkit-box-flex":"0","-webkit-box-flex-group":"1","-webkit-box-lines":"single","-webkit-box-ordinal-group":"1","-webkit-box-orient":"horizontal","-webkit-box-pack":"start","-webkit-box-reflect":"none","-webkit-box-shadow":"none","-webkit-clip-path":"none","-webkit-column-break-after":"auto","-webkit-column-break-before":"auto","-webkit-column-break-inside":"auto","-webkit-column-axis":"auto","-webkit-column-count":"auto","-webkit-column-gap":"normal","-webkit-column-progression":"normal","-webkit-column-rule-color":"rgb(0, 0, 0)","-webkit-column-rule-style":"none","-webkit-column-rule-width":"0px","-webkit-column-span":"none","-webkit-column-width":"auto","-webkit-filter":"none","align-content":"stretch","align-items":"stretch","align-self":"stretch","flex-basis":"auto","flex-grow":"0","flex-shrink":"1","flex-direction":"row","flex-wrap":"nowrap","justify-content":"flex-start","-webkit-font-kerning":"auto","-webkit-font-smoothing":"auto","-webkit-font-variant-ligatures":"normal","-webkit-highlight":"none","-webkit-hyphenate-character":"auto","-webkit-line-align":"none","-webkit-line-box-contain":"block inline replaced","-webkit-line-break":"auto","-webkit-line-clamp":"none","-webkit-line-grid":"none","-webkit-line-snap":"none","-webkit-locale":"auto","-webkit-margin-before-collapse":"collapse","-webkit-margin-after-collapse":"collapse","-webkit-marquee-direction":"auto","-webkit-marquee-increment":"6px","-webkit-marquee-repetition":"infinite","-webkit-marquee-style":"scroll","-webkit-mask-box-image":"none","-webkit-mask-box-image-outset":"0px","-webkit-mask-box-image-repeat":"stretch","-webkit-mask-box-image-slice":"0 fill","-webkit-mask-box-image-source":"none","-webkit-mask-box-image-width":"auto","-webkit-mask-clip":"border-box","-webkit-mask-composite":"source-over","-webkit-mask-image":"none","-webkit-mask-origin":"border-box","-webkit-mask-position":"0% 0%","-webkit-mask-repeat":"repeat","-webkit-mask-size":"auto","order":"0","-webkit-perspective":"none","-webkit-perspective-origin":"228px 0px","-webkit-print-color-adjust":"economy","-webkit-rtl-ordering":"logical","-webkit-tap-highlight-color":"rgba(0, 0, 0, 0.180392)","-webkit-text-combine":"none","-webkit-text-decorations-in-effect":"none","-webkit-text-emphasis-color":"rgb(0, 0, 0)","-webkit-text-emphasis-position":"over","-webkit-text-emphasis-style":"none","-webkit-text-fill-color":"rgb(0, 0, 0)","-webkit-text-orientation":"vertical-right","-webkit-text-security":"none","-webkit-text-stroke-color":"rgb(0, 0, 0)","-webkit-text-stroke-width":"0px","-webkit-transform":"none","-webkit-transform-origin":"228px 0px","-webkit-transform-style":"flat","-webkit-transition-delay":"0s","-webkit-transition-duration":"0s","-webkit-transition-property":"all","-webkit-transition-timing-function":"ease","-webkit-user-drag":"auto","-webkit-user-modify":"read-only","-webkit-user-select":"text","-webkit-writing-mode":"horizontal-tb","-webkit-app-region":"no-drag","buffered-rendering":"auto","clip-path":"none","clip-rule":"nonzero","mask":"none","filter":"none","flood-color":"rgb(0, 0, 0)","flood-opacity":"1","lighting-color":"rgb(255, 255, 255)","stop-color":"rgb(0, 0, 0)","stop-opacity":"1","color-interpolation":"srgb","color-interpolation-filters":"linearrgb","color-rendering":"auto","fill":"#000000","fill-opacity":"1","fill-rule":"nonzero","marker-end":"none","marker-mid":"none","marker-start":"none","mask-type":"luminance","shape-rendering":"auto","stroke":"none","stroke-dasharray":"none","stroke-dashoffset":"0","stroke-linecap":"butt","stroke-linejoin":"miter","stroke-miterlimit":"4","stroke-opacity":"1","stroke-width":"1","alignment-baseline":"auto","baseline-shift":"baseline","dominant-baseline":"auto","kerning":"0","text-anchor":"start","writing-mode":"lr-tb","glyph-orientation-horizontal":"0deg","glyph-orientation-vertical":"auto","vector-effect":"none"}

selector =

  stopEvt: (e)->
    e.stopPropagation()
    e.preventDefault()

  selectEl: (el)->
    offset = el.offset()
    @_highlighter.css(
      height: el.outerHeight()
      width: el.outerWidth()
      top: offset.top
      left: offset.left
    )
    @_lastTempSelected = el

  selectNextEl: (el)->
    @deselectEl()
    @selectEl @_lastTempSelected.parent()

  selectPrevEl: (el)->
    @deselectEl()
    @selectEl @_lastTempSelected.prev()

  selectParentEl: (el)->
    @deselectEl()
    @selectEl @_lastTempSelected.parent()

  selectChildEl: (el)->
    @deselectEl()
    @selectEl @_lastTempSelected.children().first()

  deselectEl: ->
    el = @_lastTempSelected
    if el?
      el.removeClass('cor-temp-selected')
        .css(el.data('originalProps') || {})

  select: (e)->
    @deselectEl()
    e.stopPropagation()
    e.preventDefault()
    @selectEl $ e.target

  camelize: (prop)->
    arr = prop.split('-')
    arr
      .slice(0,1)
      .concat(
        arr.slice(1)
          .map((i)-> i.slice(0,1).toUpperCase() + i.slice(1))
      )
      .join('')

  serializeCSS: (el)->
    styles = window.getComputedStyle(el[0])
    str = ""
    for prop in styles
      val = (styles[prop] || styles[@camelize(prop)])?.replace(/'/g, '"')
      str += "#{prop}: #{val};" if val isnt DEFAULT_STYLES[prop]
    str

  serialize: (el)->
    tag = el[0].tagName
    for tagName in 'script style link meta iframe frame'.split('')
      if tag is tagName
        return ''
    str = "<#{tag} style='#{@serializeCSS(el)}'>"
    el.contents().each (i, el)=>
      str += 
        if el.nodeType isnt 1
          $(el).text()
        else
          '\n\t'+ @serialize $ el
    str += "</#{tag}>"
    str

  submit: (e)->
    selections = []
    $('.cor-selected').each (idx, el)=>
      el = $ el
      html = @serialize el
      idx = Number el.data 'cor-selection-idx'
      selections[idx] = html
      console.log idx, ':', html
    # do something with selections
    # @showForm selections

  handleKeydown: (e)->
    switch(e.which)
      when 27 # escape
        @deactivate()
      when 39 # right arrow key
        @selectNextEl @_lastTempSelected
      when 37 # left arrow key
        @selectPrevEl @_lastTempSelected
      when 40 # down arrow key
        @selectChildEl @_lastTempSelected
      when 38 # top arrow key
        @selectParentEl @_lastTempSelected
      when 13 # enter key
        @capture(e)
    @stopEvt e

  capture: (e)->
    @stopEvt e
    el = @_lastTempSelected
    @deselectEl()
    el.addClass('cor-selected')
      .attr('data-cor-selection-idx', @_selectionIdx)
    unless e.ctrlKey
      @deactivate()
    @_selectionIdx += 1

  init: ->
    @_selectionIdx = 0

  activate: ->
    @_highlighter = $('<div>').css(
        'border': '1px solid red'
        'background': 'yellow'
        'opacity': '0.7'
        'pointer-events': 'none'
        'position': 'absolute'
        'top': 0
        'left': 0
        'height': 0
        'width': 0
        'z-index': 9999
      ).appendTo('body')
    $('body')
      .on('mouseover', $.proxy(@select, @))
      .on('click', $.proxy(@capture, @))
      .on('keydown', $.proxy(@handleKeydown, @))

  deactivate: ->
    $('body')
      .off('mouseover', @select)
      .off('click', @capture)
      .off('keydown', @handleKeydown)
    @_highlighter.remove()

$ -> selector.init()

chrome.runtime.onMessage.addListener (req, sender, cb)->
  if req.action == 'initateClip'
    selector.activate()
